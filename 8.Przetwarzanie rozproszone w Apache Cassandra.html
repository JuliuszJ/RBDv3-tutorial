<article class="markdown-body">
  <h1 class="atx" id="viii-przetwarzanie-rozproszone-w-apache-cassandra">VIII. Przetwarzanie rozproszone w Apache
    Cassandra</h1>
  <p>Celem zajęć jest zapoznanie się przetwarzaniem rozproszonym w bazie danych <a
      href="https://pl.wikipedia.org/wiki/Apache_Cassandra">Apache Cassandra</a></p>
  <h2 class="atx" id="przygotowanie-srodowiska">Przygotowanie środowiska</h2>
  <ol>
    <li>
      <p>Zaloguj się do maszyny wirtualnej jako użytkownik rbd używając hasła RBD#7102.</p>
    </li>
    <li>
      <p>Otwórz okno terminala, który nazwiemy terminalem pomocniczym.</p>
    </li>
    <li>
      <p>W pierwszym kroku pobierz plik manifestów za pomocą poniższego polecenia:</p>
      <pre><code>wget www.cs.put.poznan.pl/jjezierski/RBDv2/rbd-cassandra.yaml</code></pre>
    </li>
    <li>
      <p>Otwórz plik manifestów w celu jego przeglądnięcia za pomocą polecenia:</p>
      <pre><code>less rbd-cassandra.yaml</code></pre>
      <p>Repliki <em>Pod</em> typu <em>StatefulSet</em> wykorzystują obraz z systemem Cassandra rozszerzonym przez
        Google. Rozszerzenie to integruje system Cassandra z Kubernetes. Dzięki temu nie ma potrzeby ręcznego tworzenia
        klastra Cassandra i przydziału do niego węzłów. Kubernetes automatycznie dodaje kolejne repliki do klastra
        Cassandra jako jego węzły.</p>
    </li>
    <li>
      <p>Rozpocznij wdrożenie komponentów z pliku manifestów za pomocą następującego polecenia:</p>
      <pre><code>kubectl apply -f rbd-cassandra.yaml</code></pre>
    </li>
    <li>
      <p>Obserwuj postęp wdrożenia StatefulSet wykorzystując poniższe polecenie:</p>
      <pre><code>kubectl get sts --watch</code></pre>
      <p>Wdrożenie wymaga pobrania obrazu kontenera z repozytorium Docker, w związku z tym zajmuje chwilę. Wdrożenie
        zakończy się w momencie pojawienia się na terminalu wiersza, w którym liczba działających replik będzie równa
        liczbie żądanych replik. W naszym przypadku liczba ta równa się dwa.</p>
    </li>
    <li>
      <p>Sprawdź status klastra Cassandra, wykonaj w terminalu pomocniczym poniższe polecenie: </p>
      <pre><code class="fenced-code-block language-bash">kubectl exec -it rbd-dc1-rack1-sts-0 -- nodetool status</code></pre>
    </li>
    <li>
      <p>Otwórz dwie kolejne zakładki w oknie terminala wybierając z menu File pozycję New Tab. Nazwij te zakładki
        nazwami kolejnych replik od rbd-dc1-rack1-sts-0 do rbd-dc1-rack2-sts-0, wykorzystaj w tym celu pozycję Set Title
        z menu Terminal. W terminalach rbd-dc1-rack1-sts-0 i rbd-dc1-rack2-sts-0 będziemy wykonywać operacje na węzłach
        bazy danych uruchomionych odpowiednio w replikach rbd-dc1-rack1-sts-0 1 i rbd-dc1-rack2-sts-0.</p>
    </li>
    <li>
      <p>Obraz kontenera systemu Cassandra przygotowany przez Google nie posiada środowiska Python co uniemożliwia
        uruchomienie programu <code>cqlsh</code>, który jest interpreterem poleceń systemu Cassandra. W celu rozwiązania
        powyższego problemu uruchomimy oddzielny Pod o nazwie cqlsh z kontenerem opartym na oficjalnym obrazie
        Cassandra, który jest wyposażony w odpowiednie narzędzia. W celu uruchomienia takiego Pod wykonaj w poniższe
        polecenie w zakładce rbd-dc1-rack1-sts-0: </p>
      <pre><code class="fenced-code-block language-bash">kubectl run -it cqlsh --image cassandra:3.11 -- /bin/bash</code></pre>
    </li>
    <li>
      <p>W zakładce rbd-dc1-rack1-sts-0 przyłącz się do węzła rbd-dc1-rack1-sts-0 bazy danych za pomocą narzędzia
        <code>cqlsh</code> wykonując poniższe polecenie:</p>
      <pre><code>cqlsh rbd-dc1-rack1-sts-0.rbd-cassandra</code></pre>
    </li>
    <li>
      <p>W zakładce rbd-dc1-rack2-sts-0 przyłącz się do Pod cqlsh wykonując polecenie:</p>
      <pre><code>kubectl exec -it cqlsh -- /bin/bash</code></pre>
    </li>
    <li>
      <p>W zakładce rbd-dc1-rack2-sts-0 przyłącz się do węzła rbd-dc1-rack2-sts-0 bazy danych za pomocą narzędzia
        <code>cqlsh</code> wykonując poniższe polecenie:</p>
      <pre><code>cqlsh rbd-dc1-rack2-sts-0.rbd-cassandra</code></pre>
    </li>
  </ol>
  <h2 class="atx" id="transparentny-dostep-do-rozproszonych-danych-transparent-acess">Transparentny dostęp do
    rozproszonych danych {#transparent-acess}</h2>
  <ol>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 utwórz obiekt typu keyspace o nazwie test. Obiekty te są analogiczne do schematów
        w relacyjnych bazach danych. Dodatkowo umożliwiają określenie parametrów replikacji tabel, które zostaną w nich
        umieszczone.</p>
      <pre><code>CREATE
 KEYSPACE test WITH
 replication
 <span class="token operator">=
 
{<span class="token string">'class'
:<span class="token string">'SimpleStrategy'
<span class="token punctuation">,
 <span class="token string">'replication_factor'
 : <span class="token number">1
}<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 utwórz tabelę dist_tab w keyspace test. Definicja klucza podstawowego jest
        obowiązkowa. Może on być złożony z wielu kolumn. Pierwsza kolumna klucza jest kryterium rozpraszania wierszy na
        węzły klastra Cassandra.</p>
      <pre><code>create
 table
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">(

id int
<span class="token punctuation">,

tekst text
<span class="token punctuation">,

primary
 key
 <span class="token punctuation">(
id<span class="token punctuation">)
<span class="token punctuation">)
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 wstaw nowy wiersz do tabeli test.dist_tab:</p>
      <pre><code>insert
 into
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">(
id<span class="token punctuation">,
 tekst<span class="token punctuation">)
 values
 <span class="token punctuation">(
<span class="token number">1
<span class="token punctuation">,
 <span class="token string">'a'
<span class="token punctuation">)
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 odczytaj zawartość tabeli test.dist_tab:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack2-sts-0 odczytaj zawartość tabeli test.dist_tab:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack2-sts-0 wstaw nowy wiersz do tabeli test.dist_tab:</p>
      <pre><code>insert
 into
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">(
id<span class="token punctuation">,
 tekst<span class="token punctuation">)
 values
 <span class="token punctuation">(
<span class="token number">2
<span class="token punctuation">,
 <span class="token string">'b'
<span class="token punctuation">)
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 odczytaj zawartość tabeli test.dist_tab:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">;
</code></pre>
    </li>
  </ol>
  <h2 class="atx" id="poziomy-spojnosci-odczytu-i-zapisuconsistency-levels">Poziomy spójności odczytu i
    zapisu{#consistency-levels}</h2>
  <ol>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 sprawdź ustawienie domyślnego poziomu spójności.</p>
      <pre><code>consistency<span class="token punctuation">;
 </code></pre>
    </li>
    <li>
      <p>Zapoznaj się z dostępnymi <a
          href="https://docs.datastax.com/en/archived/cassandra/3.0/cassandra/dml/dmlConfigConsistency.html">poziomami
          spójności</a>.</p>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack2-sts-0 opuść narzędzie <code>cqlsh</code>:</p>
      <pre><code>exit
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>W celu zasymulowania awarii węzła rbd-dc1-rack2-sts-0 przeskaluj liczbę replik StatefulSet, który obsługuje
        klaster Cassandra do jednej, wykonaj w terminalu pomocniczym poniższe polecenie: </p>
      <pre><code>docker stop k3d-RBDcluster-agent-1</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym sprawdź status klastra Cassandra:</p>
      <pre><code class="fenced-code-block language-bash">kubectl exec -it -c cassandra rbd-dc1-rack1-sts-0 -- nodetool status</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 odczytaj zawartość tabeli test.dist_tab <mark>[Raport]</mark>:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 wstaw nowy wiersz do tabeli test.dist_tab <mark>[Raport]</mark>:</p>
      <pre><code>insert
 into
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">(
id<span class="token punctuation">,
 tekst<span class="token punctuation">)
 values
 <span class="token punctuation">(
<span class="token number">3
<span class="token punctuation">,
 <span class="token string">'c'
<span class="token punctuation">)
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 przełącz poziom spójności na <em>any</em>:</p>
      <pre><code>consistency any
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 odczytaj zawartość tabeli test.dist_tab <mark>[Raport]</mark>:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 wstaw nowy wiersz do tabeli test.dist_tab <mark>[Raport]</mark>:</p>
      <pre><code>insert
 into
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">(
id<span class="token punctuation">,
 tekst<span class="token punctuation">)
 values
 <span class="token punctuation">(
<span class="token number">3
<span class="token punctuation">,
 <span class="token string">'c'
<span class="token punctuation">)
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym sprawdź status klastra Cassandra:</p>
      <pre><code class="fenced-code-block language-bash">kubectl <span class="token builtin class-name">exec
 -it rbd-dc1-rack1-sts-0 -- nodetool status </code></pre>
      <p>Skopiuj do schowka identyfikator hosta węzła, który wcześniej został zatrzymany przez zmianę liczby replik.
        Posiada on status DN.</p>
    </li>
    <li>
      <p>W terminalu pomocniczym usuń zatrzymany węzeł klastra Cassandra, użyj identyfikatora ze schowka.</p>
      <pre><code>kubectl exec -it rbd-dc1-rack1-sts-0 -- nodetool removenode "Host ID"</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym sprawdź ponownie status klastra Cassandra </p>
    </li>
    <li>
      <p>Uruchom węzeł rbd-dc1-rack2-sts-0 zwiększając liczbę replik StatefulSet do dwóch. Uruchom w terminalu
        pomocniczym poniższe polecenie:</p>
      <pre><code class="fenced-code-block language-bash">kubectl scale sts rbd-cassandra --replicas<span class="token operator">=
<span class="token number">2
</code></pre>
    </li>
    <li>
      <p>Monitoruj uruchamianie repliki wykorzystując w terminalu poniższe polecenie:</p>
      <pre><code>kubectl get sts --watch</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack2-sts-0 przyłącz się do bazy danych za pomocą narzędzia cqlsh.</p>
      <pre><code class="fenced-code-block language-bash">cqlsh rbd-dc1-rack2-sts-0.rbd-cassandra</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack2-sts-0 odczytaj zawartość tabeli test.dist_tab <mark>[Raport]</mark>:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 odczytaj zawartość tabeli test.dist_tab <mark>[Raport]</mark>:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test<span class="token punctuation">.
dist_tab<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 przełącz poziom izolacji na <em>one</em>:</p>
      <pre><code>consistency one<span class="token punctuation">;
</code></pre>
    </li>
  </ol>
  <h2 class="atx" id="odpornosc-na-awarie-robustness">Odporność na awarię {#robustness}</h2>
  <ol>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 utwórz obiekt keyspace o nazwie test2 z współczynnikiem replikacji równym dwa.
      </p>
      <pre><code>CREATE
 KEYSPACE test2 WITH
 replication
 <span class="token operator">=
 
{<span class="token string">'class'
:<span class="token string">'SimpleStrategy'
<span class="token punctuation">,
 <span class="token string">'replication_factor'
 : <span class="token number">2
}<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 utwórz tabelę dist_tab2 w keyspace test2. </p>
      <pre><code>create
 table
 test2<span class="token punctuation">.
dist_tab2<span class="token punctuation">(

id int
<span class="token punctuation">,

tekst text
<span class="token punctuation">,

primary
 key
 <span class="token punctuation">(
id<span class="token punctuation">)
<span class="token punctuation">)
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 wstaw nowy wiersz do tabeli test2.dist_tab2:</p>
      <pre><code>insert
 into
 test2<span class="token punctuation">.
dist_tab2<span class="token punctuation">(
id<span class="token punctuation">,
 tekst<span class="token punctuation">)
 values
 <span class="token punctuation">(
<span class="token number">4
<span class="token punctuation">,
 <span class="token string">'e'
<span class="token punctuation">)
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>W celu zasymulowania awarii węzła rbd-dc1-rack2-sts-0 przeskaluj liczbę replik StatefulSet, który obsługuje
        klaster Cassandra do jeden, wykonaj w terminalu pomocniczym poniższe polecenie: </p>
      <pre><code>kubectl scale sts rbd-cassandra --replicas=1</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym sprawdź status klastra:</p>
      <pre><code class="fenced-code-block language-bash">kubectl <span class="token builtin class-name">exec
 -it rbd-dc1-rack1-sts-0 -- nodetool status</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 wstaw nowy wiersz do tabeli test2.dist_tab2 <mark>[Raport]</mark>:</p>
      <pre><code>insert
 into
 test2<span class="token punctuation">.
dist_tab2<span class="token punctuation">(
id<span class="token punctuation">,
 tekst<span class="token punctuation">)
 values
 <span class="token punctuation">(
<span class="token number">5
<span class="token punctuation">,
 <span class="token string">'f'
<span class="token punctuation">)
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 odczytaj zawartość tabeli test2.dist_tab2 <mark>[Raport]</mark>:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test2<span class="token punctuation">.
dist_tab2<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym sprawdź status klastra Cassandra:</p>
      <pre><code class="fenced-code-block language-bashcreate">kubectl exec -it rbd-dc1-rack1-sts-0 -- nodetool status </code></pre>
      <p> Skopiuj do schowka identyfikator hosta węzła, który wcześniej został zatrzymany przez zmianę liczby replik.
        Posiada on status DN.</p>
    </li>
    <li>
      <p>W terminalu pomocniczym usuń zatrzymany węzeł klastra Cassandra, użyj identyfikatora ze schowka.</p>
      <pre><code>kubectl exec -it rbd-dc1-rack1-sts-0 -- nodetool removenode "Host ID"</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym sprawdź ponownie status klastra Cassandra.</p>
    </li>
    <li>
      <p>Uruchom węzeł rbd-dc1-rack2-sts-0 zwiększając liczbę replik StatefulSet do dwóch. Uruchom w terminalu
        pomocniczym poniższe polecenie:</p>
      <pre><code class="fenced-code-block language-bash">kubectl scale sts rbd-cassandra --replicas<span class="token operator">=
<span class="token number">2
</code></pre>
    </li>
    <li>
      <p>Monitoruj uruchamianie repliki wykorzystując w terminalu poniższe polecenie:</p>
      <pre><code>kubectl get sts --watch</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack2-sts-0 przyłącz się do bazy danych za pomocą narzędzia cqlsh.</p>
      <pre><code>cqlsh rbd-dc1-rack2-sts-0.rbd-cassandra</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack2-sts-0 odczytaj zawartość tabeli test2.dist_tab2 <mark>[Raport]</mark>:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test2<span class="token punctuation">.
dist_tab2<span class="token punctuation">;
</code></pre>
    </li>
  </ol>
  <h2 class="atx" id="dolaczenie-nowego-wezla-do-klastra-node-creation">Dołączenie nowego węzła do klastra
    {#node-creation}</h2>
  <ol>
    <li>
      <p>Uruchom węzeł rbd-dc1-rack3-sts-0 zwiększając liczbę replik StatefulSet do trzech. Uruchom w terminalu
        pomocniczym poniższe polecenie:</p>
      <pre><code class="fenced-code-block language-bash">kubectl scale sts rbd-cassandra --replicas<span class="token operator">=
<span class="token number">3
</code></pre>
    </li>
    <li>
      <p>Monitoruj uruchamianie repliki wykorzystując w terminalu poniższe polecenie:</p>
      <pre><code>kubectl get sts --watch</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym sprawdź status klastra:</p>
      <pre><code class="fenced-code-block language-bash">kubectl <span class="token builtin class-name">exec
 -it rbd-dc1-rack1-sts-0 -- nodetool status</code></pre>
    </li>
    <li>
      <p>Otwórz nową zakładkę terminala, nazwij ją rbd-dc1-rack3-sts-0. W zakładce rbd-dc1-rack3-sts-0 przyłącz się do
        Pod cqlsh:</p>
      <pre><code class="fenced-code-block language-bash">kubectl <span class="token builtin class-name">exec
 -it cqlsh -- /bin/bash</code></pre>
    </li>
    <li>
      <p>W zakładce rbd-dc1-rack3-sts-0 przyłącz się do węzła rbd-dc1-rack3-sts-0 klastra Cassandra:</p>
      <pre><code>cqlsh rbd-dc1-rack3-sts-0.rbd-cassandra</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack3-sts-0 odczytaj zawartość tabeli test2.dist_tab2 <mark>[Raport]</mark>:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test2<span class="token punctuation">.
dist_tab2<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym wyczyść węzeły rbd-dc1-rack1-sts-0 i rbd-dc1-rack2-sts-0 z danych, które zostały
        przemieszczone do węzła rbd-dc1-rack3-sts-0.</p>
      <pre><code>kubectl exec -it rbd-dc1-rack1-sts-0 -- nodetool cleanup
kubectl exec -it rbd-dc1-rack2-sts-0 -- nodetool cleanup</code></pre>
    </li>
  </ol>
  <h2 class="atx" id="usuniecia-wezla-z-klastra-node-removal">Usunięcia węzła z klastra {#node-removal}</h2>
  <ol>
    <li>
      <p>Na węźle rbd-dc1-rack3-sts-0 opuść narzędzia cqlsh:</p>
      <pre><code>exit
<span class="token punctuation">;
</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym przekaż dane węzła rbd-dc1-rack3-sts-0 do innych węzłów klastra:</p>
      <pre><code>kubectl exec -it rbd-dc1-rack3-sts-0 -- nodetool decommission</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym monitoruj postęp operacji:</p>
      <pre><code>kubectl exec -it rbd-dc1-rack1-sts-0 -- nodetool status</code></pre>
    </li>
    <li>
      <p>W terminalu pomocniczym usuń Pod rbd-dc1-rack3-sts-0 zmniejszając liczbę replik StatefulSet rbd-cassandra do
        dwóch:</p>
      <pre><code>kubectl scale sts rbd-cassandra --replicas=2</code></pre>
    </li>
    <li>
      <p>Na węźle rbd-dc1-rack1-sts-0 odczytaj zawartość tabeli test2.dist_tab2 <mark>[Raport]</mark>:</p>
      <pre><code>select
 <span class="token operator">*
 from
 test2<span class="token punctuation">.
dist_tab2<span class="token punctuation">;
</code></pre>
    </li>
  </ol>
</article>